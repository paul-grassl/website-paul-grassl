---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getCollection } from "astro:content";
// import { Image } from "astro:assets"; // Currently unused

// Load current exhibition and landing image data
const currentData = await getCollection("current");
const landingImage = currentData.find(entry =>
  entry.id.includes("landing-image")
);

// Get all current exhibitions (filter out landing-image and only include entries with content)
const currentExhibitions = currentData
  .filter(entry => !entry.id.includes("landing-image"))
  .filter(entry => entry.data.title && entry.data.title.trim() !== "")
  .sort((a, b) => a.id.localeCompare(b.id)); // Sort alphabetically by filename

// Check if there are any current exhibitions
const hasCurrentExhibitions = currentExhibitions.length > 0;
---

<Layout title="Paul Graßl" description="Artist website">
  <Header />
  <main id="main-content" data-layout="index">
    <section class="mx-auto w-full max-w-5xl px-6 py-8">
      <div class="flex flex-col gap-y-8">
        {
          hasCurrentExhibitions && (
            <div class="w-full">
              <h1 class="mb-2 text-2xl leading-tight font-normal text-foreground">
                Current Calendar
              </h1>
              <div class="mt-4 space-y-6">
                {currentExhibitions.map(exhibition => (
                  <div class="exhibition-entry">
                    <h2 class="mb-1 text-xl font-normal text-foreground italic">
                      {exhibition.data.title}
                    </h2>
                    <div class="text-muted-foreground flex flex-col gap-y-0.5 text-lg">
                      {exhibition.data.locationUrl &&
                      exhibition.data.locationUrl.trim() !== "" ? (
                        <a
                          href={exhibition.data.locationUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="underline decoration-1 underline-offset-2 transition-colors hover:text-foreground"
                        >
                          {exhibition.data.location}
                        </a>
                      ) : (
                        <span>{exhibition.data.location}</span>
                      )}
                      {exhibition.data.type && (
                        <span>{exhibition.data.type}</span>
                      )}
                      {exhibition.data.opening && (
                        <span>{exhibition.data.opening}</span>
                      )}
                      {exhibition.data.period && (
                        <span>{exhibition.data.period}</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )
        }

        {
          landingImage && landingImage.data.image && (
            <div class="w-full">
              <div class="flex justify-center">
                <div class="w-full max-w-xl">
                  <img
                    src={landingImage.data.image}
                    alt={
                      landingImage.data.alt || "Current artwork by Paul Graßl"
                    }
                    class="h-auto w-full"
                  />
                  {landingImage.data.caption &&
                    landingImage.data.caption.trim() !== "" && (
                      <div class="mt-2 text-center">
                        <p class="text-muted-foreground text-base italic">
                          {landingImage.data.caption}
                        </p>
                      </div>
                    )}
                </div>
              </div>
            </div>
          )
        }
      </div>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
